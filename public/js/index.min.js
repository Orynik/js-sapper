import{tileMap,startButton,stopwatch,bombCounter}from"./additional.js";let tilesState=new Map;const tileWidth=17;let tiles,boardSize=256,boardSideLength=Math.sqrt(boardSize),isInitialClick=!0,board=document.getElementById("board"),isEndGame=!1,isWinGame=!1;function renderTile(){board.parentElement.style.width=`${boardSideLength*tileWidth}px`;for(let t=0;t<boardSize;t++)createTile(t);bombCounter.renderBombQty(),stopwatch.init(),tiles=document.querySelectorAll(".tile")}function setup(t=null){let e=bombCounter.bombQty,i={},l={},a=0,s=0;tiles.forEach(n=>{function o(t){Object.hasOwn(i,t)?i[t]++:i[t]=1}n.setAttribute("data-tile",`${a},${s}`);let c=Math.random()<.25;n!==t&&c&&e&&(e--,l[`${a},${s}`]=!0,a>0&&o(`${a-1},${s}`),a<boardSideLength-1&&o(`${a+1},${s}`),s>0&&o(`${a},${s-1}`),s<boardSideLength-1&&o(`${a},${s+1}`),a>0&&s>0&&o(`${a-1},${s-1}`),a<boardSideLength-1&&s<boardSideLength-1&&o(`${a+1},${s+1}`),s>0&&a<boardSideLength-1&&o(`${a+1},${s-1}`),a>0&&s<boardSideLength-1&&o(`${a-1},${s+1}`)),++a>=boardSideLength&&(a=0,s++)}),tiles.forEach(t=>{let e=t.dataset.tile,a={};Object.hasOwn(l,e)?a.hasBomb=l[e]:Object.hasOwn(i,e)?a.count=i[e]:a=null,null!==a&&tilesState.set(e,a)}),stopwatch.start()}function clickTile(t){if(t.classList.contains("tile--checked")||t.classList.contains("tile--flagged")||t.classList.contains("tile-question"))return;let e=t.getAttribute("data-tile");if(tilesState.has(e)){if(tilesState.get(e).hasBomb)endGame(t);else if(tilesState.get(e).count){let i=tilesState.get(e).count;t.classList.add("tile--checked"),t.classList.add(`tile${tileMap.get(i)}`),setTimeout(()=>{checkVictory()},100)}}else checkTile(e),t.classList.add("tile--checked")}function checkTile(t){let e=t.split(","),i=parseInt(e[0]),l=parseInt(e[1]);setTimeout(()=>{if(i>0){clickTile(document.querySelectorAll(`[data-tile="${i-1},${l}"`)[0],!1)}if(i<boardSideLength-1){clickTile(document.querySelectorAll(`[data-tile="${i+1},${l}"`)[0],!1)}if(l>0){clickTile(document.querySelectorAll(`[data-tile="${i},${l-1}"]`)[0],!1)}if(l<boardSideLength-1){clickTile(document.querySelectorAll(`[data-tile="${i},${l+1}"]`)[0],!1)}if(i>0&&l>0){clickTile(document.querySelectorAll(`[data-tile="${i-1},${l-1}"`)[0],!1)}if(i<boardSideLength-1&&l<boardSideLength-1){clickTile(document.querySelectorAll(`[data-tile="${i+1},${l+1}"`)[0],!1)}if(l>0&&i<boardSideLength-1){clickTile(document.querySelectorAll(`[data-tile="${i+1},${l-1}"]`)[0],!1)}if(i>0&&l<boardSideLength-1){clickTile(document.querySelectorAll(`[data-tile="${i-1},${l+1}"`)[0],!1)}},10)}function createTile(){function t(){return new Promise(t=>{isEndGame||isWinGame||t()})}let e=document.createElement("div");e.classList.add("tile"),e.addEventListener("mousedown",i=>{t().then(()=>{e.classList.contains("tile-question")||e.classList.contains("tile--flagged")||2===i.button||(e.classList.add("tile--focus"),startButton.toggleFear())})}),e.addEventListener("mouseout",()=>{t().then(()=>{e.classList.contains("tile-question")||e.classList.contains("tile--flagged")||(e.classList.remove("tile--focus"),startButton.toggleFear(!1))})}),e.addEventListener("click",function(i){t().then(()=>{e.classList.contains("tile-question")||e.classList.contains("tile--flagged")||(isInitialClick&&(setup(i.target),isInitialClick=!1),clickTile(e))})}),e.addEventListener("contextmenu",function(e){e.preventDefault(),t().then(()=>{if(!e.target.classList.contains("tile--checked"))if(e.target.classList.contains("tile--flagged"))bombCounter.incrementBomb(),e.target.classList.remove("tile--flagged"),e.target.classList.add("tile-question");else if(e.target.classList.contains("tile-question"))e.target.classList.remove("tile-question"),e.target.classList.remove("tile-question--focus"),e.target.classList.remove("tile--flagged");else{if(!bombCounter.bombQty)return;bombCounter.decrementBomb(),e.target.classList.add("tile--flagged")}e.target.classList.remove("tile--focus")})}),board.appendChild(e)}function endGame(t){isEndGame=!0,t.classList.add("tile-bomb--focus"),tilesState.forEach((t,e)=>{let i=document.querySelector(`.tile[data-tile="${e}"]`);Object.hasOwn(t,"hasBomb")&&(i.classList.contains("tile--flagged")?i.classList.add("tile-bomb","tile-bomb--disable"):i.classList.add("tile-bomb"))}),startButton.toggleLose(),stopwatch.stop()}function checkVictory(){document.querySelectorAll(".tile--checked").length===boardSize-1&&(document.querySelectorAll(".tile:not(.tile--checked)").forEach(t=>{t.classList.contains("tile--flagged")||t.classList.add("tile--flagged")}),startButton.toggleWin(),isWinGame=!0,stopwatch.stop())}function startGame(){isEndGame=!1,isWinGame=!1,isInitialClick=!0,bombCounter.resetQty(),startButton.toggleLose(!1),startButton.toggleWin(!1),stopwatch.clear(),tilesState.clear(),tiles.forEach(t=>{t.remove()}),renderTile()}startButton.init(startGame),renderTile();